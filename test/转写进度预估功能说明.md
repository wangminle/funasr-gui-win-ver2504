# FunASR GUI 客户端 - 转写进度预估功能说明

## 功能概述

FunASR GUI客户端已成功实现智能转写进度预估功能，能够根据文件特征和服务器性能动态调整等待策略，并向用户提供直观的进度反馈。

## 核心功能

### 1. 动态调整转写等待时延
- **智能超时计算**：替换原有固定600秒超时，根据音频时长和测速结果动态计算
- **差异化管理**：区分"转写等待时长"（系统超时底线）和"转写预估时长"（用户交互显示）
- **自适应策略**：基于服务器转写倍速自动调整超时策略

### 2. 转写进度预估显示
- **实时倒计时**：在状态栏显示倒计时和百分比进度
- **阶段化显示**：
  - 上传阶段：显示"上传中..."
  - 转写阶段：显示"转写中 X% (剩余: X分X秒)"
  - 超时状态：显示"已超预估时间 (已用时: X分X秒)"

### 3. 基于测速结果的智能计算
- **无测速时**：
  - 等待时长 = 音频时长/5（向上取整）
  - 预估时长 = 音频时长/10（向上取整）
- **有测速时**：
  - 预估时长 = (音频时长/转写倍速) × 120%（向上取整）
  - 等待时长 = 倍速>5时用音频时长/5，否则用音频时长

### 4. 会话数据管理
- **软件关闭时自动清零**：确保每次启动都是全新状态
- **测速结果持久化**：在软件运行期间保持测速结果

## 技术实现

### 核心类：TranscribeTimeManager

```python
class TranscribeTimeManager:
    def __init__(self):
        # 测速结果
        self.last_upload_speed = None      # MB/s
        self.last_transcribe_speed = None  # 倍速
        
        # 当前文件信息
        self.current_file_duration = None  # 秒
        self.current_file_size = None      # 字节
        
        # 计算结果
        self.transcribe_wait_timeout = 600     # 系统超时时长
        self.transcribe_estimate_time = None   # 用户预估时长
```

### 关键方法

1. **get_audio_duration(file_path)**
   - 使用mutagen库获取音频/视频文件时长
   - 支持多种格式：MP3, WAV, MP4, AVI等

2. **calculate_transcribe_times(file_path)**
   - 核心计算方法，返回(wait_timeout, estimate_time)
   - 实现智能计算逻辑

3. **set_speed_test_results(upload_speed, transcribe_speed)**
   - 设置测速结果，用于后续计算

4. **clear_session_data()**
   - 清除会话数据，软件关闭时调用

### GUI集成要点

1. **文件选择时**：显示文件时长信息
2. **识别开始前**：计算并显示预估时长
3. **转写过程中**：实时更新进度和倒计时
4. **速度测试后**：自动更新测速结果

## 使用场景示例

### 场景1：首次使用（无测速数据）
- 选择3分钟音频文件
- 系统计算：等待超时36秒，预估18秒
- 状态显示：转写中 50% (剩余: 9秒)

### 场景2：高性能服务器（30倍速）
- 选择3分钟音频文件
- 系统计算：等待超时36秒，预估8秒
- 状态显示：转写中 75% (剩余: 2秒)

### 场景3：低性能服务器（3倍速）
- 选择3分钟音频文件
- 系统计算：等待超时180秒，预估72秒
- 状态显示：转写中 25% (剩余: 54秒)

## 依赖要求

```
websockets>=10.0
mutagen
```

注：tkinter和asyncio为Python内置模块

## 测试验证

运行测试脚本验证功能：
```bash
python3 test_time_manager.py
```

测试覆盖：
- 无测速结果场景
- 高倍速场景
- 低倍速场景  
- 无法获取文件时长场景
- 实际方法调用验证

## 文件结构

```
src/python-gui-client/
├── funasr_gui_client_v2.py     # 主GUI程序
├── simple_funasr_client.py     # 转写脚本（支持动态超时）
├── requirements.txt            # 依赖列表
test_time_manager.py            # 测试脚本
```

## 特色亮点

1. **用户体验友好**：直观的进度显示和剩余时间预估
2. **智能自适应**：根据服务器性能动态调整策略
3. **健壮性强**：支持无时长信息文件的降级处理
4. **集成度高**：与现有速度测试功能完美集成
5. **多语言支持**：支持中英文界面切换

这个实现为FunASR GUI客户端提供了专业级的转写进度管理能力，大大提升了用户体验和使用效率。 