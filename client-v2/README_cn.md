# FunASR GUI 客户端 V2

这是一个基于 Tkinter 的图形用户界面 (GUI) 客户端，用于与 FunASR (FunASR ASR) WebSocket 服务进行交互，实现语音识别功能。

## ✨ 功能特性

### 核心功能
*   **服务器连接配置**: 允许用户输入 FunASR WebSocket 服务器的 IP 地址和端口。
*   **连接测试**: 提供按钮测试与服务器的 WebSocket 连接状态（包括 SSL），默认超时5秒，可通过`dev/config/config.json`配置。
*   **文件选择**: 支持选择本地的音频/视频文件（如 `.wav`, `.mp3`, `.pcm`, `.mp4` 等）或 `.scp` 列表文件进行识别。
*   **离线识别**: 通过调用客户端脚本 (`simple_funasr_client.py`) 执行 FunASR 的离线识别模式。
*   **热词支持**: 可选择热词文件提高特定领域识别准确率，支持带权重配置。

### 用户界面
*   **UI分离**: 识别结果与运行日志分选项卡显示，提供"复制结果"和"清空结果"按钮。
*   **状态管理增强**: StatusManager类管理5种状态颜色（成功/信息/警告/错误/处理中），细化识别8个阶段提示+Emoji图标。
*   **国际化支持**: 提供中英文界面切换功能，满足不同语言背景用户的需求。
*   **实时输出显示**: 在 GUI 中实时显示识别过程中的状态信息和最终识别结果。

### 高级功能
*   **高级选项**: 支持启用/禁用逆文本标准化 (ITN) 和 SSL 连接。
*   **服务器速度测试**: 提供专用按钮测试服务器的上传速度和转写速度，使用demo目录中的测试文件计算并显示上传速度（MB/s）和转写速度（倍速）。
*   **智能时长预估**: 自动检测音频/视频文件的真实播放时长，根据速度测试结果动态计算转写预估时间和等待超时时长，提供实时进度显示和倒计时功能。
*   **兜底处理策略**: 当无法获取音频时长时，使用固定20分钟等待时长，确保所有文件都能正常处理。

### 系统功能
*   **依赖检查与安装**: 自动检查并提示/尝试安装所需的 Python 依赖包 (`websockets`, `mutagen`)，延迟导入避免无依赖环境导入失败。
*   **日志记录**: 生成独立的日志文件，包含详细的操作记录和错误信息，便于问题排查，支持日志轮转（5MB，保留3个备份）。
*   **配置持久化**: 保存上次使用的服务器IP、端口、高级选项和热词文件路径，下次启动时自动加载。
*   **进程管理增强**: 统一的进程安全终止方法，terminate→wait→kill完整流程，完整的进程退出状态日志记录。
*   **优化上传速度**: 针对离线模式进行了上传速度优化，提高了处理效率。
*   **协议优化**: 修正了offline模式下的协议处理，确保与服务端正确通信。
*   **文件结构优化**: 重构了文件存储结构，将配置文件、日志和识别结果分别存储在独立目录中。
*   **代码对齐v0.2.0**: 通过与验证过的v0.2.0参考实现对齐，简化并稳定了代码库。

## 🐍 环境要求

*   **Python**: 3.8 或更高版本 (推荐使用项目运行时使用的 Python 版本，例如 3.12)。
*   **Tkinter**: Python 标准库，通常随 Python 安装。
*   **必要的 Python 包**:
    *   `websockets`: 用于 WebSocket 通信。
    *   `mutagen`: 用于检测音频/视频文件时长。
    *   `logging`: 用于生成日志文件（Python 标准库）。
    *   *(注意: GUI 客户端会在首次连接或识别时尝试自动安装这些依赖)*

## 🚀 安装与设置（pipenv）

```bash
pipenv install --skip-lock
pipenv install --dev --skip-lock
```

## 🛠️ 使用方法

1.  **启动 GUI**:
    ```bash
    cd path/to/funasr-gui-win-ver2504 # 进入项目根目录
    pipenv run python src/python-gui-client/funasr_gui_client_v2.py
    ```
2.  **配置服务器**: 在 "服务器连接配置" 区域输入 FunASR WebSocket 服务器的 IP 地址和端口。
3.  **测试连接 (可选)**: 点击 "连接服务器" 按钮检查网络连通性。连接成功后，指示灯会变绿。
4.  **选择文件**: 点击 "选择音/视频文件" 按钮，选择您要识别的音频或视频文件。
5.  **配置选项 (可选)**: 根据需要勾选或取消勾选 "启用 ITN" 和 "启用 SSL"。
6.  **切换语言 (可选)**: 从语言下拉框中选择"中文"或"English"来切换界面语言。
7.  **开始识别**: 点击 "开始识别" 按钮。
8.  **查看结果**: 识别过程中的日志和最终结果将显示在 "运行日志与结果" 区域。状态栏会显示当前状态。识别结果文本文件将保存在 `dev/output/` 目录下。
9.  **查看日志**: 点击 "打开日志文件" 按钮可以打开日志文件，查看详细的操作记录和错误信息。
10. **查看识别结果**: 点击 "打开结果目录" 按钮可以直接打开保存识别结果的目录。
11. **测试服务器速度**: 点击 "速度测试" 按钮可以测试服务器的上传速度和转写速度。测试会自动使用demo目录中的测试文件（tv-report-1.mp4和tv-report-1.wav）进行两次测试，并计算平均上传速度（MB/s）和转写速度（倍时）。测试完成后，会在界面上显示结果，并弹出详细的测试结果对话框。

### 代码检查（pipenv）
```bash
pipenv run python src/tools/run_lints.py
pipenv run python src/tools/run_lints.py --fix
pipenv run python src/tools/run_lints.py --mypy-only --paths src
```

## 📁 文件结构

```
funasr-gui-win-ver2504/
├── dev/
│   ├── config/                           # 配置文件目录
│   │   ├── config.json                   # 用户配置文件（IP、端口、SSL、ITN、热词路径等）
│   │   ├── flake8.ini                    # Flake8配置
│   │   ├── mypy.ini                      # MyPy配置
│   │   └── pyproject.toml                # Black和isort配置
│   ├── logs/                             # 日志文件目录
│   │   └── funasr_gui_client.log         # 程序运行日志（支持轮转）
│   └── output/                           # 识别结果输出目录
│       └── [识别结果文件].txt            # 识别结果文本文件
├── src/
│   ├── python-gui-client/
│   │   ├── funasr_gui_client_v2.py       # GUI 客户端主程序
│   │   ├── simple_funasr_client.py       # WebSocket 客户端脚本（延迟导入）
│   │   ├── connection_tester.py          # WebSocket 连接测试模块 (2025-10-24)
│   │   └── requirements.txt              # Python依赖列表
│   └── tools/
│       └── run_lints.py                  # Lint 与类型检查脚本
├── docs/                                 # 项目文档（markdown格式）
│   ├── v2/                              # V2版本文档
│   │   ├── funasr-python-gui-client-v2-架构设计.md
│   │   ├── funasr-python-gui-client-v2-需求文档.md
│   │   ├── funasr-python-gui-client-v2-UI定义.md
│   │   ├── funasr-python-gui-client-v2-项目管理.md
│   │   └── funasr-python-gui-client-v2-CS协议解析.md
│   └── technical-review/                # 技术评审文档
├── tests/                                # 测试目录
│   ├── scripts/                         # 测试脚本（23个）
│   └── reports/                         # 测试报告（29个）
├── ref/                                  # 参考代码和文档（只读）
│   └── FunASR-main/                     # FunASR官方仓库参考
├── resources/                            # 资源文件
│   └── demo/                            # Demo音视频文件
│       ├── tv-report-1.mp4
│       └── tv-report-1.wav
├── Pipfile                              # Pipenv依赖定义
├── Pipfile.lock                         # Pipenv锁定版本
├── README.md                            # 英文README
└── README_cn.md                         # 中文README
```

## ⚠️ 已知问题与限制

*   当前主要支持 FunASR 的 **离线 (offline)** 识别模式。
*   暂未实现对 Online 和 2Pass 模式的可视化配置（如 `chunk_size`, `chunk_interval` 等参数）。
*   部分音频文件的元数据可能损坏，此时会自动启用兜底策略（固定20分钟等待时长）。

## 🔜 开发计划

根据项目管理文档，以下功能规划中（按P0/P1/P2优先级）：

### P0级 - 稳定性改进
*   ~~**连接测试抽象**: 封装ConnectionTester类，统一建链、发首包、接首包逻辑~~ ✅ 已完成 (2025-10-24)
*   **日志清理策略**: 增加"保留N天/最大M MB"的自动清理机制

### P1级 - 功能扩展
*   **支持 Online 和 2Pass 模式**: 扩展支持更多识别模式，满足不同场景需求
*   **添加Tooltips说明**: 为关键控件添加说明，降低学习成本
*   **.scp批量处理优化**: 显示当前文件和总体进度，暴露thread_num并发参数

### P2级 - 工程化
*   **打包分发**: 使用Nuitka打包成可执行文件，一键运行无需Python环境
*   **配置功能增强**: 常用服务器列表、一键重试、快速切换SSL
*   **性能优化**: Offline上传速度优化、内存管理改进、启动速度优化

## ✅ 最近更新

### V2.4.1 - ConnectionTester模块 (2025-10-24)
*   **ConnectionTester类实现** (P0): 创建独立的连接测试模块，包含：
    - `ErrorType` 错误类型枚举（NETWORK/PROTOCOL/TIMEOUT/SSL/UNKNOWN）
    - `ConnectionTestResult` 数据类，用于结构化测试结果
    - `ConnectionTester` 类，统一连接测试逻辑
    - websockets依赖延迟导入支持
    - 用户友好的错误消息和技术详情日志记录 ✅

### V2.4 - P0/P1优先级改进版 (2025-10-23)
*   **依赖导入重构** (P0-1): 将websockets导入移至main()函数，实现延迟导入，避免无依赖环境导入失败 ✅
*   **进程退出保护增强** (P0-2): 创建统一的`_terminate_process_safely()`方法，实现terminate→wait→kill完整流程 ✅
*   **热词文件支持** (P1-1): GUI中添加热词文件选择、清除按钮和路径显示，支持Tooltip格式说明（中英文） ✅
*   **状态栏信息细化** (P1-2): 创建StatusManager类管理状态，实现5种状态颜色区分，细化识别8个阶段提示+Emoji图标 ✅
*   **测试成果**: 新增4个测试脚本、4个测试报告，总测试用例21个，测试通过率100% (21/21) ✅

### V2.3 - 代码对齐版 (2025-01-15)
*   **代码对齐v0.2.0**: 成功将dev版本与验证过的v0.2.0参考实现对齐
*   **架构简化**: 移除了过度复杂的取消识别功能，提高了稳定性
*   **目录结构优化**: 更新为使用`dev/output`输出目录，遵循cursorrules规范
*   **可靠性增强**: 用v0.2.0的简洁高效版本替换了复杂实现
*   **完整集成测试**: 所有6/6项集成测试成功通过

### V2.2 - 智能预估版 (2024年)
*   **UI分离**: 实现识别结果与运行日志的选项卡式分离，提供复制和清空功能
*   **智能时长预估**: 完成音频时长自动检测和智能预估功能
*   **兜底处理策略**: 实现音频时长获取失败时的兜底机制（固定20分钟）
*   **状态栏信息增强**: 完成转写进度实时显示和倒计时功能
*   **国际化支持**: 完成中英文界面切换功能，包括新功能的完整翻译
*   **超时机制优化**: 修复硬编码10秒通信超时问题，改为基于音频时长的智能动态超时
*   **多层超时保护**: 实现主要超时、通信超时和兜底超时的三层保护机制

### 技术债务清理
*   移除了`recognition_running`、`cancel_event`等复杂状态变量
*   简化了识别流程，提高了代码稳定性
*   优化了错误处理逻辑，使用验证过的v0.2.0实现
*   增强了进程和资源管理机制
*   新增StatusManager类，规范状态管理
*   代码行数净增465行，测试代码750+行，中文注释覆盖率100%

## 🤝 贡献

欢迎提出问题、报告错误或贡献代码改进！

## 📄 许可证

(可在此添加许可证信息，例如 MIT License) 