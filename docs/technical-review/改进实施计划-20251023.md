# FunASR GUI Client V2 改进实施计划

**制定日期:** 2025-10-23  
**基于:** 工程师Review评估报告  
**总预计时间:** 8-10周

---

## 快速概览

| 阶段 | 里程碑 | 优先级 | 预计时间 | 核心目标 |
|------|--------|--------|----------|----------|
| 1 | A - 稳定性改进 | P0 | 1周 | 依赖重构、连接测试抽象、日志清理 |
| 2 | B - 模式与参数 | P1 | 1-2周 | Online/2Pass模式、热词支持 |
| 3 | C - 体验优化 | P1 | 1周 | 状态栏细化、Tooltips、批量进度 |
| 4 | D - 工程化 | P2 | 2周 | 国际化外置、打包分发 |
| 5 | E - 可选增强 | P2 | 1-2周 | 性能优化、安全增强 |

---

## 阶段一：稳定性改进（P0）[1周]

### 周1: 依赖与连接优化

#### Day 1-2: 依赖导入重构
**目标文件:** `src/python-gui-client/simple_funasr_client.py`

```python
# 修改前（第18行）
import websockets

# 修改后（延迟导入）
def main():
    try:
        import websockets
    except ImportError:
        print("错误：缺少websockets库，请运行: pip install websockets>=10.0")
        sys.exit(1)
    # ... 其余代码
```

**子任务:**
- [ ] 将websockets导入移到main()函数内
- [ ] 添加友好的ImportError提示
- [ ] 在GUI启动时预检查依赖
- [ ] 编写测试: `test_dependency_import_20251023.py`

#### Day 3-4: 连接测试抽象

**新增文件:** `src/python-gui-client/connection_tester.py`

```python
class ConnectionTester:
    """WebSocket连接测试器"""
    
    async def test_connection(self, host, port, use_ssl, timeout=5):
        """测试连接并返回详细结果"""
        pass
    
    def parse_error(self, exception):
        """解析异常并返回友好的错误信息"""
        pass
```

**子任务:**
- [ ] 实现ConnectionTester类
- [ ] 重构GUI的`_async_test_connection`方法
- [ ] 统一协议片段（初始化消息）
- [ ] 编写单元测试: `test_connection_tester_20251023.py`

#### Day 5: 日志清理策略

**修改文件:** `src/python-gui-client/funasr_gui_client_v2.py`

**新增配置:** `dev/config/config.json`
```json
{
    "logging": {
        "max_log_files": 30,
        "max_total_size_mb": 100
    }
}
```

**子任务:**
- [ ] 实现启动时自动清理旧日志
- [ ] 添加"清理旧日志"按钮（可选）
- [ ] 编写测试: `test_log_cleanup_20251023.py`
- [ ] 生成测试报告

---

## 阶段二：功能扩展（P1）[2-3周]

### 周2-3: 模式选择与参数打通

#### 任务2.1: GUI模式选择
**修改文件:** `src/python-gui-client/funasr_gui_client_v2.py`

**UI设计:**
```
┌─ 识别模式 ─────────────────┐
│ ◉ Offline (离线模式)        │
│ ○ Online (在线模式)         │
│ ○ 2Pass (二次识别)          │
│                            │
│ [Online/2Pass参数]         │
│ Chunk Size: [5,10,5]       │
│ Chunk Interval: [10]       │
└────────────────────────────┘
```

**子任务:**
- [ ] 添加模式选择单选按钮
- [ ] 动态显示/隐藏参数输入框
- [ ] 参数透传到子进程
- [ ] 测试Online模式实时结果
- [ ] 测试2Pass模式中间结果
- [ ] 编写测试: `test_mode_selection_20251023.py`

#### 任务2.2: 热词文件支持

**UI设计:**
```
┌─ 热词文件 ─────────────────┐
│ 热词文件: [无]              │
│ [选择热词文件] [清除]       │
│ ℹ 格式: 每行一个词，空格后跟权重 │
└────────────────────────────┘
```

**子任务:**
- [ ] 添加热词文件选择控件
- [ ] 透传`--hotword`参数
- [ ] 添加格式验证（可选）
- [ ] 编写测试: `test_hotword_support_20251023.py`

### 周4: 体验优化

#### 任务3.1: 状态栏细化

**实现方案:**
```python
class StatusManager:
    """状态管理器"""
    
    STATUS_COLORS = {
        'success': 'green',
        'progress': 'blue',
        'warning': 'orange',
        'error': 'red'
    }
    
    def update_status(self, message, status_type, auto_reset=False):
        """更新状态栏"""
        pass
```

**子任务:**
- [ ] 实现StatusManager类
- [ ] 细化识别阶段提示
- [ ] 添加颜色和图标
- [ ] 实现短暂信息自动恢复
- [ ] 更新多语言资源

#### 任务3.2: 添加Tooltips

**实现方案:**
```python
def add_tooltip(widget, text):
    """为控件添加Tooltip"""
    tooltip = tk.Toplevel()
    # ... 实现
```

**子任务:**
- [ ] 为所有按钮添加Tooltips
- [ ] 为参数输入框添加说明
- [ ] 支持多语言Tooltips
- [ ] 编写测试: `test_ui_enhancements_20251023.py`

#### 任务3.3: .scp批量优化

**实现方案:**
- 解析simple_funasr_client.py的stdout，提取当前文件信息
- 在状态栏显示: "正在处理: file1.wav (2/10)"

**子任务:**
- [ ] 添加thread_num参数设置
- [ ] 显示当前文件名和总体进度
- [ ] 优化批量错误处理
- [ ] 编写测试: `test_batch_processing_20251023.py`

---

## 阶段三：工程化（P2）[2周]

### 周5-6: 国际化与打包

#### 任务4.1: 国际化外置化

**目录结构:**
```
dev/
├── i18n/
│   ├── zh.json     # 中文
│   ├── en.json     # 英文
│   └── ja.json     # 日语（示例）
```

**zh.json示例:**
```json
{
    "app_title": "FunASR GUI 客户端 V2",
    "server_config_frame": "服务器连接配置",
    "ready": "准备就绪"
}
```

**子任务:**
- [ ] 导出现有翻译到JSON
- [ ] 重构LanguageManager加载JSON
- [ ] 添加新语言示例
- [ ] 编写资源验证工具
- [ ] 编写测试: `test_i18n_externalized_20251023.py`

#### 任务4.2: 打包分发

**评估工具:**
| 工具 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| Nuitka | 编译为原生代码，性能好 | 编译慢，体积大 | ⭐⭐⭐⭐ |
| PyInstaller | 打包快，体积小 | 启动慢 | ⭐⭐⭐⭐⭐ |

**打包脚本示例 (PyInstaller):**
```bash
pyinstaller --onefile \
    --windowed \
    --add-data "dev/i18n:i18n" \
    --add-data "resources:resources" \
    --icon="icon.ico" \
    src/python-gui-client/funasr_gui_client_v2.py
```

**子任务:**
- [ ] 评估Nuitka vs PyInstaller
- [ ] 编写打包脚本
- [ ] 处理动态资源
- [ ] 实现首次运行引导
- [ ] 在Windows和macOS测试
- [ ] 编写安装说明

---

## 阶段四：可选增强（P2）[1-2周]

### 任务5.1: 性能优化
- [ ] 使用cProfile分析性能瓶颈
- [ ] 优化WebSocket数据传输
- [ ] 优化GUI响应速度

### 任务5.2: 安全增强
- [ ] 添加SSL证书验证选项
- [ ] 添加输入校验
- [ ] 加密存储敏感信息

### 任务5.3: 高级功能
- [ ] 支持拖放文件
- [ ] 任务队列管理
- [ ] 识别历史记录
- [ ] 自动更新检查

---

## 测试策略

### 每个任务完成后必须:

1. **编写测试脚本** → `tests/scripts/test_[功能名称]_[日期].py`
2. **执行测试** → 确保所有测试通过
3. **生成测试报告** → `tests/reports/test_[功能名称]_summary_[日期].md`
4. **代码检查** → 运行black, isort, flake8, mypy
5. **更新文档** → 同步更新相关文档

### 测试模板:

```python
# tests/scripts/test_xxx_20251023.py
"""测试xxx功能
测试内容:
1. 正常功能测试
2. 边界条件测试
3. 异常情况测试
"""

def test_normal_case():
    """正常功能测试"""
    pass

def test_boundary_case():
    """边界条件测试"""
    pass

def test_exception_case():
    """异常情况测试"""
    pass

if __name__ == "__main__":
    # 执行测试
    pass
```

---

## 里程碑验收标准

每个里程碑完成后，必须满足:

- ✅ 所有功能测试通过（正常/边界/异常）
- ✅ 所有文档已更新（架构/需求/UI/项目管理）
- ✅ 代码通过lint检查（black, isort, flake8, mypy）
- ✅ 生成测试总结报告
- ✅ 在Windows和macOS上验证通过
- ✅ 用户验收测试通过

---

## 风险与对策

| 风险 | 等级 | 对策 |
|------|------|------|
| 依赖兼容性问题 | 中 | 提前在各平台测试，准备降级方案 |
| 打包工具限制 | 中 | 评估多个工具，选择最合适的 |
| 性能回退 | 低 | 每次改动后进行性能测试 |
| UI兼容性问题 | 低 | 在多个平台和屏幕分辨率测试 |
| 用户学习成本 | 低 | 提供详细文档和Tooltips |

---

## 下一步行动

### 立即开始（本周）:
1. **创建分支**: `git checkout -b feature/p0-stability-improvements`
2. **任务A1**: 重构依赖导入（预计2天）
3. **任务A2**: 抽象连接测试（预计2天）
4. **任务A3**: 日志清理策略（预计1天）
5. **生成测试报告和文档更新**

### 开发规范提醒:
- ✅ 所有代码使用中文注释
- ✅ 类名驼峰命名，函数名下划线命名
- ✅ 每次commit前运行lint检查
- ✅ 每个功能必须有测试
- ✅ 输出文件到`dev/output`
- ✅ 日志记录到`dev/logs`
- ✅ 配置文件在`dev/config`

---

**计划制定完毕，准备开始实施！** 🚀

