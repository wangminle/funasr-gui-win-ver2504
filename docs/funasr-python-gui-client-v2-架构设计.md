# FunASR Python GUI Client V2 架构设计文档

**最后更新日期:** 2025-11-03

## 1. 项目概述

### 1.1 项目目标
开发一个基于Python的桌面客户端工具，内置FunASR引擎的WebSocket通讯协议，实现语音识别功能，并支持速度测试。项目严格遵循cursorrules规范，采用测试驱动开发模式。

### 1.2 核心功能
- 语音/视频文件的语音识别
- 实时WebSocket通信
- 速度测试与性能评估
- 多语言界面支持
- 配置管理与日志记录
- 测试驱动的质量保证体系

### 1.3 架构原则
- **简洁稳定**: 基于v0.2.0参考实现，移除过度复杂功能
- **规范遵循**: 严格遵循cursorrules目录结构和开发规范
- **测试驱动**: 每个功能模块都有对应的测试验证
- **文档先行**: 架构设计文档指导具体实现

## 2. 系统架构

### 2.1 整体架构
```
┌─────────────────────────────────────────────────────────────┐
│                    FunASR GUI Client V2                     │
├─────────────────────────────────────────────────────────────┤
│  GUI层 (tkinter)                                           │
│  ├─ 用户界面组件                                           │
│  ├─ 事件处理                                               │
│  ├─ 多语言支持                                             │
│  └─ 状态管理（简化后）                                     │
├─────────────────────────────────────────────────────────────┤
│  业务逻辑层                                                 │
│  ├─ 连接管理                                               │
│  ├─ 文件处理                                               │
│  ├─ 识别控制（v0.2.0简化版）                               │
│  ├─ 速度测试                                               │
│  └─ 时长预估                                               │
├─────────────────────────────────────────────────────────────┤
│  通信层                                                     │
│  ├─ WebSocket客户端（v0.2.0版本）                          │
│  ├─ 进程管理（简化）                                       │
│  └─ 同步通信                                               │
├─────────────────────────────────────────────────────────────┤
│  工具层                                                     │
│  ├─ 配置管理                                               │
│  ├─ 日志系统                                               │
│  ├─ 时间管理                                               │
│  └─ 测试工具                                               │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 模块架构（v0.2.0简化版）
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  GUI主进程      │    │  识别子进程      │    │  FunASR服务器   │
│ (主程序)        │    │ (simple_client) │    │                │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ • 界面管理      │    │ • WebSocket通信 │    │ • 语音识别引擎  │
│ • 用户交互      │◄──►│ • 文件处理      │◄──►│ • 模型加载      │
│ • 进程控制      │    │ • 协议实现      │    │ • 结果返回      │
│ • 状态显示      │    │ • 数据传输      │    │ • 连接管理      │
│ • 结果收集      │    │ • 结果输出      │    │                │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 3. 目录结构架构（严格遵循cursorrules）

### 3.1 标准目录结构
```
funasr-gui-win-ver2504/
├── dev/                        # 开发目录（主要工作区）
│   ├── src/                    # 源代码目录
│   │   └── python-gui-client/  # 主要源码
│   │       ├── funasr_gui_client_v2.py    # GUI主程序
│   │       ├── simple_funasr_client.py    # WebSocket客户端
│   │       └── requirements.txt           # 依赖管理
│   ├── output/                 # 开发过程输出文件
│   ├── config/                 # 配置文件
│   │   └── config.json         # 主配置文件
│   ├── logs/                   # 日志文件
│   │   └── funasr_gui_client.log
│   ├── release/                # 发布版本目录
│   │   ├── config/             # 发布配置
│   │   ├── logs/               # 发布日志
│   │   └── results/            # 识别结果输出
│   └── demo/                   # 演示文件
├── docs/                       # 项目文档（markdown格式）
│   ├── funasr-python-gui-client-v2-架构设计.md
│   ├── funasr-python-gui-client-v2-需求文档.md
│   ├── funasr-python-gui-client-v2-UI定义.md
│   └── funasr-python-gui-client-v2-项目管理.md
├── tests/                      # 测试目录
│   ├── test_[功能名称]_[日期].py      # 测试脚本
│   ├── test_[功能名称]_summary_[日期].md  # 测试总结
│   └── test_output_[日期]/            # 测试输出
└── ref/                        # 参考代码和文档（只读）
    ├── v0.2.0/                 # v0.2.0参考实现
    ├── ref_codes/              # 参考代码
    └── ref_docs/               # 参考文档
```

### 3.2 目录职责说明
- **dev/**: 所有开发活动的主目录
- **dev/src/**: 源代码存放，所有代码使用中文注释
- **dev/output/**: 开发过程中的输出文件
- **dev/release/results/**: 用户识别结果的输出目录（v0.2.0规范）
- **docs/**: 项目文档，markdown格式，包含四个重要文档
- **tests/**: 测试脚本、测试数据和测试总结文档
- **ref/**: 参考资料，不允许修改

## 4. 核心模块设计

### 4.1 GUI主程序 (funasr_gui_client_v2.py)

#### 4.1.1 主要类结构（v0.2.0简化版 + 2025-10-23增强）
- **FunASRGUIClient**: 主窗口类，继承自tk.Tk
- **LanguageManager**: 多语言管理器
- **TranscribeTimeManager**: 时间管理器
- **StatusManager**: 状态管理器（2025-10-23新增）
- **GuiLogHandler**: GUI日志处理器

#### 4.1.2 架构简化要点
```python
# 移除的复杂功能（基于v0.2.0对齐）
- recognition_running 状态变量
- cancel_event 取消事件
- 复杂的取消识别功能
- 过度的异步处理逻辑

# 保留的核心功能
- 基本的GUI界面管理
- 简洁的识别流程控制
- 配置和日志管理
- 速度测试功能
- 多语言支持
```

#### 4.1.3 核心功能模块
1. **界面管理**
   - 服务器连接配置区
   - 文件选择与执行区
   - 高级选项区
   - 速度测试区
   - 日志显示区

2. **连接管理**
   - 服务器连接测试
   - 连接状态指示
   - SSL/TLS支持

3. **识别控制（简化版）**
   - 文件选择与验证
   - 识别进程启动
   - 进度跟踪
   - 结果收集

4. **速度测试**
   - 测试文件处理
   - 上传速度计算
   - 转写速度评估
   - 结果统计

5. **热词管理（2025-10-23新增）**
   - 热词文件选择
   - 热词文件清除
   - 热词路径显示
   - 热词配置持久化

### 4.2 识别子进程 (simple_funasr_client.py)

#### 4.2.1 v0.2.0架构特点（+ 2025-10-23增强）
- **完全替换**: 使用v0.2.0参考实现
- **功能专注**: 专注于WebSocket通信核心功能
- **逻辑简洁**: 移除复杂的增强功能
- **效率优化**: 更简洁的wav_name处理逻辑
- **延迟导入**: websockets等依赖延迟导入，避免无依赖环境导入失败（2025-10-23新增）
- **热词支持**: 支持--hotword参数透传（2025-10-23新增）

#### 4.2.2 主要功能
- WebSocket连接建立
- 音频文件处理
- 数据分块传输
- 识别结果接收
- 结果文件输出

#### 4.2.3 通信协议
- 初始化消息发送
- 音频数据传输
- 结束标志发送
- 结果接收处理

### 4.3 配置管理系统

#### 4.3.1 配置文件结构（更新至2025-10-23）
```json
{
    "server": {
        "ip": "127.0.0.1",
        "port": "10095"
    },
    "options": {
        "use_itn": 1,
        "use_ssl": 1,
        "hotword_file": ""  // 2025-10-23新增：热词文件路径
    },
    "ui": {
        "language": "zh"
    },
    "connection_test_timeout": 5  // 连接测试超时（秒）
}
```

#### 4.3.2 配置存储位置（cursorrules规范）
- 配置文件：`dev/config/config.json`
- 日志文件：`dev/logs/funasr_gui_client.log`（支持轮转，5MB，保留3个备份）
- 识别结果：`dev/output/`（从v2.3开始统一使用）
- 代码检查配置：`dev/config/flake8.ini`、`dev/config/mypy.ini`、`dev/config/pyproject.toml`

### 4.4 状态管理系统（2025-10-23新增）

#### 4.4.1 StatusManager类
**核心职责：** 统一管理GUI状态显示，提供清晰的视觉反馈

**状态类型与颜色：**
- **SUCCESS（成功）**: 绿色 - 操作成功完成
- **INFO（信息）**: 蓝色 - 正常流程信息
- **WARNING（警告）**: 橙色 - 需要注意的情况
- **ERROR（错误）**: 红色 - 错误或失败
- **PROCESSING（处理中）**: 灰色 - 正在进行的操作

**识别阶段细化（8个阶段+Emoji）：**
1. ⚙️ 准备识别任务
2. 📖 读取文件
3. 🔌 连接服务器
4. ⬆️ 上传音频
5. 🔄 服务器处理中
6. ⬇️ 接收识别结果
7. ✅ 识别完成
8. ❌ 识别失败（错误状态）

**临时状态自动恢复：**
- 短暂操作提示（如"文件已选择"）显示3秒后自动恢复
- 使用`self.after()`实现异步状态恢复

#### 4.4.2 进程安全管理（2025-10-23增强）

**统一终止方法：** `_terminate_process_safely()`

**终止流程：**
```python
def _terminate_process_safely(self, process, process_name="进程"):
    """统一的进程安全终止方法
    
    1. 尝试terminate()（SIGTERM）
    2. 等待5秒让进程自行退出
    3. 如果仍在运行，使用kill()（SIGKILL）
    4. 记录完整的退出状态日志
    """
```

**应用位置：**
- 识别流程3处：正常完成、超时、异常
- 速度测试2处：正常完成、异常

**日志记录：**
- 记录进程启动和PID
- 记录terminate尝试
- 记录wait结果和退出码
- 记录kill操作（如需要）

### 4.5 日志系统

#### 4.5.1 日志级别
- DEBUG: 调试信息
- INFO: 一般信息
- WARNING: 警告信息
- ERROR: 错误信息

#### 4.5.2 日志输出
- 文件日志：自动轮转，保留历史（`dev/server-logs/`为外部服务端日志采集目录，已加入.gitignore）
- GUI日志：实时显示在界面中
- 控制台日志：开发调试使用

#### 4.5.3 日志分类（2025-10-23增强）
- **系统事件:** 应用程序级别操作
- **用户操作:** 用户触发的操作
- **脚本输出:** 子进程stdout
- **脚本错误:** 子进程stderr
- **调试信息:** 详细的调试信息

## 5. 技术选型

### 5.1 开发语言和环境
- **Python 3.12**: 主要开发语言
- **标准库优先**: 尽量使用Python标准库
- **代码风格**: 中文注释，类名驼峰命名，函数名下划线命名

### 5.2 核心依赖（v0.2.0规范）
```
websockets>=10.0    # WebSocket通信
mutagen>=1.47.0     # 音频文件时长检测
```

### 5.3 GUI技术选型
- **tkinter**: 标准GUI库，跨平台兼容性好
- **ttk**: 现代化控件样式
- **多线程**: 界面响应性保证

### 5.4 文件格式支持
- **音频格式**: WAV, MP3, M4A等
- **视频格式**: MP4, AVI, MOV等
- **配置格式**: JSON
- **日志格式**: 文本格式

## 6. 数据流设计

### 6.1 识别流程（简化版）
```
用户选择文件 → 连接服务器 → 启动识别进程 → 文件上传 → 
服务器处理 → 结果返回 → 保存到results目录 → 界面显示
```

### 6.2 速度测试流程
```
启动测试 → 选择测试文件 → 记录时间点 → 执行识别 → 
计算速度 → 统计结果 → 显示报告 → 预估时长更新
```

### 6.3 配置管理流程
```
程序启动 → 加载config.json → 应用到界面 → 
用户修改 → 实时保存 → 下次启动加载
```

## 7. 测试架构（cursorrules规范）

### 7.1 测试原则
- **每个开发任务完成后必须有对应测试脚本**
- **测试脚本放在/tests目录**
- **包含正常功能、边界条件、异常情况测试**
- **生成测试总结文档**

### 7.2 测试类型
1. **单元测试**: 模块功能测试
2. **集成测试**: 模块间协作测试
3. **端到端测试**: 完整流程测试
4. **性能测试**: 速度和资源占用测试
5. **兼容性测试**: 平台和版本兼容测试

### 7.3 测试文件命名规范
- 测试脚本: `test_[功能名称]_[日期].py`
- 测试总结: `test_[功能名称]_summary_[日期].md`
- 测试输出: `test_output_[日期]/`

### 7.4 测试用例覆盖
- **GUI界面测试**: 界面元素和交互测试
- **WebSocket通信测试**: 连接和数据传输测试
- **文件处理测试**: 各种格式文件的处理测试
- **配置管理测试**: 配置读写和迁移测试
- **多语言测试**: 界面语言切换测试
- **异常处理测试**: 错误情况的处理测试

## 8. 安全设计

### 8.1 网络安全
- SSL/TLS加密通信
- 证书验证（可选）
- 连接超时控制
- 动态超时机制（基于预估时长）

### 8.2 文件安全
- 文件路径验证
- 文件类型检查
- 临时文件清理
- 输出目录权限控制

### 8.3 进程安全
- 子进程隔离
- 资源限制
- 异常处理
- 内存管理

## 9. 性能优化

### 9.1 界面响应
- 进程分离（GUI进程 + 识别进程）
- 进度指示器
- 非阻塞UI更新
- 智能超时机制

### 9.2 内存管理
- 及时释放资源
- 避免内存泄漏
- 合理的缓存策略
- 大文件分块处理

### 9.3 网络优化
- 连接复用
- 数据分块传输
- 动态超时控制
- 错误重试机制

## 10. 扩展性设计

### 10.1 模块化架构
- 清晰的模块边界
- 松耦合设计
- 接口标准化
- 配置驱动

### 10.2 多语言支持
- 资源文件分离
- 动态语言切换
- 本地化适配
- 文本资源管理

### 10.3 功能扩展预留
- 插件接口预留
- 配置扩展机制
- 新识别模式支持
- 批量处理增强

## 11. 部署架构

### 11.1 开发环境部署
```
1. 克隆代码仓库
2. 进入dev/src/python-gui-client目录
3. 安装依赖: pip install -r requirements.txt
4. 运行: python funasr_gui_client_v2.py
```

### 11.2 生产环境部署
```
1. 使用nuitka打包成可执行文件
2. 包含所有依赖项
3. 配置默认服务器地址
4. 提供用户手册
```

### 11.3 依赖管理
- requirements.txt: Python依赖列表
- 自动依赖检查与安装
- 版本兼容性管理
- SSL证书问题处理

## 12. 维护与监控

### 12.1 日志监控
- 错误日志收集
- 性能指标记录
- 用户行为分析
- 自动日志轮转

### 12.2 版本管理
- 语义化版本号
- 更新检查机制
- 向后兼容性
- 配置迁移

### 12.3 故障处理
- 异常捕获机制
- 自动恢复策略
- 用户反馈渠道
- 故障诊断工具

## 13. 架构演进总结

### 13.1 v0.2.0对齐的架构改进（至2025-10-23）
1. **代码简洁性**: 移除不必要的复杂功能（v2.3）
2. **稳定性提升**: 使用验证过的稳定实现（v2.3）
3. **规范遵循**: 严格遵循cursorrules目录结构（v2.3）
4. **测试驱动**: 完善的测试覆盖体系（持续）
5. **依赖管理增强**: 延迟导入避免无依赖环境导入失败（v2.4, 2025-10-23）
6. **进程管理增强**: 统一的进程安全终止流程（v2.4, 2025-10-23）
7. **状态管理规范化**: StatusManager类提供清晰的状态反馈（v2.4, 2025-10-23）
8. **热词功能完善**: GUI层面的热词文件支持（v2.4, 2025-10-23）

### 13.2 架构优势（更新至2025-10-23）
1. **简洁可维护**: 清晰的模块划分和简洁的实现
2. **稳定可靠**: 基于验证过的v0.2.0实现，增强进程管理
3. **规范合规**: 符合项目开发规范
4. **扩展友好**: 预留扩展接口和配置机制，热词支持完善
5. **测试完备**: 完整的测试验证体系（100%通过率）
6. **状态清晰**: StatusManager提供5种状态类型，8个识别阶段
7. **进程安全**: 统一的进程终止流程，完整的退出状态日志
8. **依赖友好**: 延迟导入机制，友好的依赖缺失提示

### 13.3 技术债务管理
- 定期代码重构
- 依赖版本更新
- 性能优化迭代
- 文档同步维护

## 14. 总结

本架构设计文档基于cursorrules规范和v0.2.0对齐经验，定义了FunASR Python GUI Client V2的完整架构体系。该架构具有以下核心特点：

1. **规范驱动**: 严格遵循cursorrules的目录结构和开发规范
2. **简洁稳定**: 基于v0.2.0参考实现，移除过度复杂功能
3. **测试为先**: 完善的测试架构确保质量
4. **文档完备**: 四个重要文档指导开发实施
5. **模块清晰**: 合理的模块划分便于开发维护
6. **扩展友好**: 预留接口支持未来功能扩展

该架构为项目的持续开发、质量保证和长期维护提供了坚实的基础，确保项目能够按照既定规范高质量完成开发目标。 