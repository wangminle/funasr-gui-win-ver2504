# FunASR Python GUI Client V2 架构设计文档

## 1. 项目概述

### 1.1 项目目标
开发一个基于Python的桌面客户端工具，内置FunASR引擎的WebSocket通讯协议，实现语音识别功能，并支持速度测试。

### 1.2 核心功能
- 语音/视频文件的语音识别
- 实时WebSocket通信
- 速度测试与性能评估
- 多语言界面支持
- 配置管理与日志记录

## 2. 系统架构

### 2.1 整体架构
```
┌─────────────────────────────────────────────────────────────┐
│                    FunASR GUI Client V2                     │
├─────────────────────────────────────────────────────────────┤
│  GUI层 (tkinter)                                           │
│  ├─ 用户界面组件                                           │
│  ├─ 事件处理                                               │
│  └─ 多语言支持                                             │
├─────────────────────────────────────────────────────────────┤
│  业务逻辑层                                                 │
│  ├─ 连接管理                                               │
│  ├─ 文件处理                                               │
│  ├─ 识别控制                                               │
│  └─ 速度测试                                               │
├─────────────────────────────────────────────────────────────┤
│  通信层                                                     │
│  ├─ WebSocket客户端                                        │
│  ├─ 进程管理                                               │
│  └─ 异步通信                                               │
├─────────────────────────────────────────────────────────────┤
│  工具层                                                     │
│  ├─ 配置管理                                               │
│  ├─ 日志系统                                               │
│  └─ 时间管理                                               │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 模块架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  GUI主进程      │    │  识别子进程      │    │  FunASR服务器   │
│ (主程序)        │    │ (simple_client) │    │                │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ • 界面管理      │    │ • WebSocket通信 │    │ • 语音识别引擎  │
│ • 用户交互      │◄──►│ • 文件处理      │◄──►│ • 模型加载      │
│ • 进程控制      │    │ • 协议实现      │    │ • 结果返回      │
│ • 状态管理      │    │ • 数据传输      │    │ • 连接管理      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 3. 核心模块设计

### 3.1 GUI主程序 (funasr_gui_client_v2.py)

#### 3.1.1 主要类结构
- **FunASRGUIClient**: 主窗口类，继承自tk.Tk
- **LanguageManager**: 多语言管理器
- **TranscribeTimeManager**: 时间管理器
- **GuiLogHandler**: GUI日志处理器

#### 3.1.2 核心功能模块
1. **界面管理**
   - 服务器连接配置区
   - 文件选择与执行区
   - 高级选项区
   - 速度测试区
   - 日志显示区

2. **连接管理**
   - 服务器连接测试
   - 连接状态指示
   - SSL/TLS支持

3. **识别控制**
   - 文件选择与验证
   - 识别进程启动
   - 识别取消机制
   - 进度跟踪

4. **速度测试**
   - 测试文件处理
   - 上传速度计算
   - 转写速度评估
   - 结果统计

### 3.2 识别子进程 (simple_funasr_client.py)

#### 3.2.1 主要功能
- WebSocket连接建立
- 音频文件处理
- 数据分块传输
- 识别结果接收
- 取消指令处理

#### 3.2.2 通信协议
- 初始化消息发送
- 音频数据传输
- 结束标志发送
- 结果接收处理

### 3.3 配置管理系统

#### 3.3.1 配置文件结构
```json
{
    "server": {
        "ip": "127.0.0.1",
        "port": "10095"
    },
    "options": {
        "use_itn": true,
        "use_ssl": true
    },
    "ui": {
        "language": "zh"
    }
}
```

#### 3.3.2 配置存储位置
- 配置文件：`dev/config/config.json`
- 日志文件：`dev/logs/funasr_gui_client.log`
- 输出文件：`dev/output/`

### 3.4 日志系统

#### 3.4.1 日志级别
- DEBUG: 调试信息
- INFO: 一般信息
- WARNING: 警告信息
- ERROR: 错误信息

#### 3.4.2 日志输出
- 文件日志：自动轮转，保留历史
- GUI日志：实时显示在界面中
- 控制台日志：开发调试使用

## 4. 技术选型

### 4.1 开发语言
- **Python 3.12**: 主要开发语言
- **标准库优先**: 尽量使用Python标准库

### 4.2 核心依赖
- **tkinter**: GUI界面开发
- **websockets**: WebSocket通信
- **asyncio**: 异步编程
- **threading**: 多线程处理
- **subprocess**: 子进程管理

### 4.3 文件格式支持
- **音频格式**: WAV, MP3, M4A等
- **视频格式**: MP4, AVI, MOV等
- **配置格式**: JSON
- **日志格式**: 文本格式

## 5. 数据流设计

### 5.1 识别流程
```
用户选择文件 → 连接服务器 → 启动识别 → 文件处理 → 
数据传输 → 服务器处理 → 结果返回 → 界面显示
```

### 5.2 速度测试流程
```
启动测试 → 选择测试文件 → 记录时间点 → 执行识别 → 
计算速度 → 统计结果 → 显示报告
```

### 5.3 取消机制
```
用户点击取消 → 发送取消指令 → 等待响应 → 
强制终止进程 → 清理资源 → 重置状态
```

## 6. 安全设计

### 6.1 网络安全
- SSL/TLS加密通信
- 证书验证（可选）
- 连接超时控制

### 6.2 文件安全
- 文件路径验证
- 文件类型检查
- 临时文件清理

### 6.3 进程安全
- 子进程隔离
- 资源限制
- 异常处理

## 7. 性能优化

### 7.1 界面响应
- 异步操作处理
- 进度指示器
- 非阻塞UI更新

### 7.2 内存管理
- 及时释放资源
- 避免内存泄漏
- 合理的缓存策略

### 7.3 网络优化
- 连接复用
- 数据压缩
- 超时控制

## 8. 扩展性设计

### 8.1 插件架构
- 预留插件接口
- 模块化设计
- 配置驱动

### 8.2 多语言支持
- 资源文件分离
- 动态语言切换
- 本地化适配

### 8.3 平台适配
- 跨平台兼容
- 系统集成
- 原生体验

## 9. 部署架构

### 9.1 目录结构
```
funasr-gui-win-ver2504/
├── dev/
│   ├── src/                 # 源代码
│   ├── output/              # 输出文件
│   ├── config/              # 配置文件
│   └── logs/                # 日志文件
├── docs/                    # 项目文档
├── tests/                   # 测试文件
├── ref/                     # 参考资料
└── demo/                    # 演示文件
```

### 9.2 依赖管理
- requirements.txt: Python依赖列表
- 自动依赖检查与安装
- 版本兼容性管理

## 10. 维护与监控

### 10.1 日志监控
- 错误日志收集
- 性能指标记录
- 用户行为分析

### 10.2 版本管理
- 版本号规范
- 更新检查机制
- 向后兼容性

### 10.3 故障处理
- 异常捕获机制
- 自动恢复策略
- 用户反馈渠道

## 11. 总结

本架构设计文档定义了FunASR Python GUI Client V2的整体架构、模块设计和技术选型。该架构具有以下特点：

1. **模块化设计**: 清晰的模块划分，便于开发和维护
2. **可扩展性**: 预留扩展接口，支持功能增强
3. **用户友好**: 直观的界面设计，良好的用户体验
4. **稳定可靠**: 完善的错误处理和资源管理
5. **跨平台**: 支持主流操作系统

该架构为项目的后续开发和维护提供了坚实的基础。 