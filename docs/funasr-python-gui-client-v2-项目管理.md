# FunASR Python GUI Client V2 - 项目管理文档

## 最新更新记录

### 2025-09-29 - 局域网联调与连接测试优化
- ✅ **连接测试可配置:** 新增`connection_test_timeout`，当前默认5秒；首包无响应视为“已建立但未响应”，允许继续测速/识别。
- ✅ **严格成功判定:** 仅在捕获“识别结果”或生成结果文件时判定成功。
- ✅ **stderr可视化:** 识别与测速流程同步消费stderr并写入GUI日志。
- ✅ **子进程退出码:** 客户端异常返回非零退出码，GUI据此判失败。
- ✅ **统一提示:** 统一为“系统事件: 正在进行连接测试...”。
- ✅ **忽略服务端日志:** `dev/server-logs/`加入.gitignore。

### 2025-07-23 - UI分离功能实现完成
- ✅ **目录结构规范化:** 调整为符合架构设计文档的dev目录结构
- ✅ **UI分离实现:** 实现识别结果与运行日志的选项卡式分离
- ✅ **配置文件迁移:** 自动迁移旧配置文件到新目录位置
- ✅ **功能增强:** 添加复制结果和清空结果功能
- ✅ **多语言支持:** 新UI组件完全支持中英文切换
- ✅ **测试验证:** 4/4项测试全部通过
- ✅ **文档更新:** 完成UI分离功能测试总结文档

**主要改进:**
- 目录结构从release调整为dev（config、logs、output）
- UI升级为选项卡式界面，清晰分离结果和日志
- 用户体验显著改善，操作更便捷
- 保持完全向后兼容性

### 2025-07-23 - 代码对齐v0.2.0完成
- ✅ **代码对齐任务完成:** dev版本代码已完全对齐到v0.2.0参考实现
- ✅ **移除复杂功能:** 删除了过度复杂的取消识别功能
- ✅ **目录结构优化:** 更新为使用release/results输出目录
- ✅ **简化实现:** simple_funasr_client.py完全替换为v0.2.0简洁版本
- ✅ **测试验证:** 6/6项集成测试全部通过
- ✅ **文档更新:** 完成测试总结文档编写

**技术债务清理:**
- 移除了recognition_running、cancel_event等复杂状态变量
- 简化了识别流程，提高了代码稳定性
- 优化了错误处理逻辑，使用验证过的v0.2.0实现

## 后续开发计划

根据需求文档的第二阶段开发建议，整理的待办事项列表：

## 用户体验优化 (UI/UX)

- [ ] **(P1) 状态栏信息增强:**
    - [ ] 显示更详细的识别阶段（读取文件、上传进度、服务器处理、接收结果等）。
    - [ ] 使用不同颜色/图标区分状态（成功、进行中、警告、错误）。
    - [ ] 实现短暂信息（如"文件已选择"）几秒后自动恢复。
- [x] **(P0) 结果与日志分离:**
    - [x] 使用 `ttk.Notebook` 分割界面为选项卡式。
    - [x] 创建独立的"识别结果"区域，只显示最终文本。
    - [x] 提供"复制结果"按钮。
    - [x] 创建独立的"运行日志"区域，显示详细过程、调试和错误信息。
    - [x] 添加"清空结果"按钮。
    - [x] 识别结果自动添加时间戳和文件名标识。
    - [x] 识别完成后自动切换到结果选项卡。
    - [ ] （可选）在日志区域添加日志级别控制（如"显示调试信息"）。
- [x] **(P0) 增强错误处理:**
    - [x] 捕获常见的网络、文件、服务器错误。
    - [x] 以友好的方式（弹窗或状态栏提示）告知用户。
    - [x] 实现音频文件时长获取失败的错误处理和兜底机制。
    - [x] 修复Windows环境下的变量作用域错误。
    - [x] 修复硬编码10秒通信超时问题，改为基于预估时间的动态超时。
- [x] **(P1) 简化取消功能 (已完成代码对齐):**
    - [x] 移除了过度复杂的取消识别功能实现
    - [x] 恢复了简洁稳定的识别流程
    - [x] 优化了进程管理和资源清理机制
- [ ] **(P2) UI/UX 细节打磨:**
    - [ ] 调整控件间距和对齐。
    - [ ] 为关键控件添加 Tooltips 提示。
- [x] **(P2) 配置持久化:**
    - [x] 保存上次使用的服务器 IP、端口。
    - [x] 保存上次使用的高级选项（ITN, SSL 等）。
    - [x] 程序启动时自动加载保存的配置。
    - [x] 配置文件保存在 `dev/config/config.json`。
- [x] **(P1) 进度显示优化:**
    - [x] 优化实时进度显示（代码中已有处理 `\r` 的尝试，但需改进）。
    - [x] 添加进度条显示总体完成百分比。
    - [x] 在文件较大时提供预估剩余时间。
    - [x] 实现音频时长检测和智能预估机制。
    - [x] 添加转写进度实时倒计时显示。
    - [x] 实现音频时长获取失败时的兜底策略（固定20分钟等待时长）。

## 功能扩展

- [ ] **(P2) 支持 Online 模式:**
    - [ ] 添加模式选择控件 (Offline, Online, 2Pass)。
    - [ ] 允许配置 Online 模式的参数 (`--chunk_size`, `--chunk_interval`)。
    - [ ] 处理并显示实时返回的中间结果。
- [ ] **(P2) 支持 2Pass 模式:**
    - [ ] 添加模式选择控件 (Offline, Online, 2Pass)。
    - [ ] 允许配置 2Pass 模式的参数 (`--chunk_size`, `--chunk_interval`)。
    - [ ] 处理并显示相关的结果。
- [ ] **(P1) 支持热词文件:**
    - [ ] 添加"选择热词文件"按钮和路径显示框。
    - [ ] 将热词文件路径传递给 `--hotword` 参数。
    - [ ] （可选）提供热词文件格式的简单说明。
- [x] **(P1) 配置输出目录:**
    - [x] 识别结果默认保存到 `dev/output` 目录（遵循架构设计文档）。
    - [x] 识别完成后提示结果已保存。
    - [x] 提供"打开结果目录"按钮。
    - [x] 自动从旧的release/results目录迁移到新的dev/output目录。
    - [ ] （可选）添加输入框允许用户自定义输出目录。
- [ ] **(P2) 优化多文件处理 (.scp):**
    - [ ] 在日志或状态栏显示当前处理的文件名。
    - [ ] 显示 `.scp` 文件处理的总体进度。
- [ ] **(P2) 批量处理增强:**
    - [ ] 提供更友好的多文件处理界面。
    - [ ] 支持拖放多个文件。
    - [ ] 添加处理队列和任务管理。
- [ ] **(P3) 高级参数暴露:**
    - [ ] 添加更多高级参数的配置界面（例如 `--send_without_sleep`、`--sample_rate` 等）。
    - [ ] 提供参数帮助说明。
- [x] **(P1) 速度测试功能:**
    - [x] 添加速度测试按钮和结果显示区域。
    - [x] 使用 demo 目录中的测试文件进行上传和转写速度测试。
    - [x] 计算并显示上传速度（MB/s）和转写速度（倍速）。
    - [x] 支持状态显示（未测试、测试进行中、测试完成）。
- [x] **(P1) 智能转写时长预估:**
    - [x] 使用 mutagen 库自动检测音频/视频文件时长。
    - [x] 根据速度测试结果动态计算转写预估时长和等待超时时长。
    - [x] 实现基于业务逻辑的时长计算规则。
    - [x] 添加音频时长获取失败的兜底策略（固定20分钟等待）。
    - [x] 在UI中区分显示有/无速度测试结果的不同状态消息。

## 性能与可靠性

- [x] **(P0) 超时机制优化:**
    - [x] 修复硬编码10秒通信超时与智能时长预估系统的冲突。
    - [x] 实现基于预估时间的动态通信超时机制（最小30秒）。
    - [x] 完善国际化支持，包括超时相关的错误消息。
- [x] **(P1) 优化 Offline 上传速度:**
    - [x] 调研并决定是否在调用脚本时添加 `--send_without_sleep` 参数。
    - [x] 或考虑修改 `simple_funasr_client.py` 移除 offline 模式下的 `sleep`。
- [x] **(P1) 确保 Offline 模式协议正确性:**
    - [x] 修正 `simple_funasr_client.py` 在 offline 模式下发送的初始消息，使其不包含 chunk 参数。
    - [x] 修正 `simple_funasr_client.py` 对单个文件输入时的 `wav_name` 处理。
- [ ] **(P2) 暴露并发参数:**
    - [ ] 在高级选项中添加 `--thread_num` 的配置，用于 `.scp` 文件处理。
- [x] **(P0) 生成独立的日志文件:**
    - [x] 引入 Python `logging` 模块。
    - [x] 将日志同时输出到"运行日志"区域和本地文件 (`dev/logs/funasr_gui_client.log`)。
    - [x] 日志包含时间戳、级别和类别前缀。
    - [x] 已实现日志轮转 (`RotatingFileHandler`)。
    - [x] 已提供"打开日志文件"的按钮。
- [ ] **(P3) (高级) 直接 WebSocket 集成:**
    - [ ] 评估将 WebSocket 逻辑直接整合到 GUI 后台线程的可行性和收益。
    - [ ] （如果实施）重构后台处理逻辑，移除 `subprocess` 调用。
- [x] **(P2) 依赖管理改进:**
    - [x] 改进依赖检查和安装机制（解决SSL证书问题）。
    - [x] 提供更友好的依赖安装失败处理。
    - [x] 添加 mutagen 库依赖检查和自动安装。
    - [ ] 考虑使用虚拟环境或捆绑依赖（如打包时）。

## 文件结构优化

- [x] **(P1) 文件路径优化 (已完成代码对齐):**
    - [x] 将配置文件从 `src/python-gui-client/config.json` 移动到 `dev/config/config.json`。
    - [x] 将日志文件从 `src/python-gui-client/funasr_gui_client.log` 移动到 `dev/logs/funasr_gui_client.log`。
    - [x] **更新:** 将识别结果输出目录设置为 `release/results` (符合v0.2.0规范)。
    - [x] 添加"打开结果目录"按钮，方便用户查看识别结果。
    - [x] 实现旧配置文件和日志文件的自动迁移功能。
    - [x] **新增:** 代码对齐后确保目录结构完全符合@cursorrules和v0.2.0规范。

## 分发与其他

- [ ] **(P1) 打包:**
    - [ ] 使用 nuitka 创建可执行文件。
    - [ ] 确保包含所有依赖项。
- [x] **(P3) 国际化支持:**
    - [x] 添加英语界面选项。
    - [x] 实现语言切换功能。
    - [x] 为新增的音频时长预估功能添加完整的英文翻译。
- [ ] **(P3) 自动更新检查:**
    - [ ] 添加检查新版本的功能。
    - [ ] 提供更新提示或自动更新选项。
