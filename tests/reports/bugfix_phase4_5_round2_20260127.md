# Phase 4 & Phase 5 Bug ä¿®å¤æŠ¥å‘Šï¼ˆç¬¬äºŒè½®ï¼‰

**ä¿®å¤æ—¥æœŸ**: 2026-01-27  
**ä¿®å¤äººå‘˜**: å¼€å‘å›¢é˜Ÿ  
**å®¡æŸ¥æ¥æº**: ä»£ç å®¡æŸ¥åé¦ˆï¼ˆç¬¬äºŒè½®ï¼‰

---

## 1. ä¿®å¤æ¦‚è¿°

æœ¬è½®ä¿®å¤é’ˆå¯¹ Phase 4/5 ä»£ç å®¡æŸ¥ä¸­å‘ç°çš„ **5 ä¸ªé—®é¢˜**ï¼ˆ2 ä¸ª P0ã€1 ä¸ª P1ã€1 ä¸ª P2ã€1 ä¸ª P3ï¼‰ï¼Œå…¨éƒ¨å·²ä¿®å¤å¹¶é€šè¿‡æµ‹è¯•éªŒè¯ã€‚

| ä¼˜å…ˆçº§ | é—®é¢˜æè¿° | ä¿®å¤çŠ¶æ€ |
|--------|----------|----------|
| **P0** | æ¢æµ‹ç¼“å­˜å†™å›å¯èƒ½è¦†ç›–/å›æ»šç”¨æˆ·é…ç½® | âœ… å·²ä¿®å¤ |
| **P0** | GUI æ¢æµ‹è°ƒç”¨ timeout å›ºå®š 5 ç§’ | âœ… å·²ä¿®å¤ |
| **P1** | ç¼“å­˜æ¢å¤ç»“æœè¢«"æ­£åœ¨æ¢æµ‹"è¿…é€Ÿè¦†ç›– | âœ… å·²ä¿®å¤ |
| **P2** | æµ‹è¯•è„šæœ¬æœªä½¿ç”¨çš„ import | âœ… å·²ä¿®å¤ |
| **P3** | æ¢æµ‹ç»“æœæ¡† columnspan æœªè¦†ç›–æ–°å¢æ¢æµ‹çº§åˆ«åˆ— | âœ… å·²ä¿®å¤ |

---

## 2. è¯¦ç»†ä¿®å¤è¯´æ˜

### 2.1 P0: æ¢æµ‹ç¼“å­˜å†™å›å¯èƒ½è¦†ç›–/å›æ»šç”¨æˆ·é…ç½®

**é—®é¢˜æ ¹å› **:
`_cache_probe_result()` ç›´æ¥æŠŠ `self.config` æ•´ä½“å†™å› `config.json`ã€‚ä½† UI ä¸Šå¾ˆå¤šå­—æ®µï¼ˆå¦‚ `probe_level_var`ï¼‰åœ¨å˜æ›´æ—¶æœªå¿…åŒæ­¥æ›´æ–°åˆ° `self.config`ï¼Œå¯¼è‡´ï¼š
- ç”¨æˆ·åˆ‡æ¢æ¢æµ‹çº§åˆ« â†’ è‡ªåŠ¨æ¢æµ‹è§¦å‘ â†’ ç¼“å­˜å†™å› â†’ `protocol.probe_level` è¢«å†™å›æ—§å€¼
- ç”¨æˆ·æ‰‹åŠ¨æ”¹ IP/ç«¯å£ä½†æœªä¿å­˜ â†’ æ¢æµ‹è§¦å‘ â†’ é…ç½®æ–‡ä»¶è¢«æ—§ `self.config` è¦†ç›–

**ä¿®å¤æ–¹æ¡ˆ**: é‡‡ç”¨"åªæ›´æ–° cache èŠ‚ç‚¹"ç­–ç•¥

```python
def _cache_probe_result(self, caps):
    """P0ä¿®å¤ï¼šåªæ›´æ–° cache èŠ‚ç‚¹ï¼Œä¸ç”¨ self.config æ•´ä½“è¦†ç›–"""
    try:
        # ä»æ–‡ä»¶è¯»å–æœ€æ–°é…ç½®
        file_config = {}
        if os.path.exists(self.config_file):
            with open(self.config_file, "r", encoding="utf-8") as f:
                file_config = json.load(f)
        
        # åªæ›´æ–° cache èŠ‚ç‚¹
        file_config.setdefault("cache", {})
        file_config["cache"]["last_probe_result"] = caps.to_dict()
        file_config["cache"]["last_probe_time"] = datetime.now().isoformat()
        
        # å†™å›æ–‡ä»¶ï¼ˆåªæ”¹äº† cache èŠ‚ç‚¹ï¼‰
        with open(self.config_file, "w", encoding="utf-8") as f:
            json.dump(file_config, f, indent=4, ensure_ascii=False)
        
        # åŒæ­¥æ›´æ–°å†…å­˜ä¸­çš„ cache èŠ‚ç‚¹
        if hasattr(self, "config"):
            self.config["cache"] = file_config["cache"]
    except Exception as e:
        logging.warning(f"ç¼“å­˜æ¢æµ‹ç»“æœå¤±è´¥: {e}")
```

**ä¿®æ”¹æ–‡ä»¶**: `src/python-gui-client/funasr_gui_client_v3.py`

---

### 2.2 P0: GUI æ¢æµ‹è°ƒç”¨ timeout å›ºå®š 5 ç§’

**é—®é¢˜æ ¹å› **:
GUI æ¢æµ‹è°ƒç”¨ `probe.probe(level, timeout=5.0)` ä¸­ timeout å›ºå®šä¸º 5 ç§’ï¼Œä½† `twopass_full` æ¢æµ‹åŒ…å«è¿æ¥+ç¦»çº¿ç­‰å¾…+æ–°è¿æ¥+2passç­‰å¾…ï¼Œå…¬ç½‘/æ…¢æœºä¸Šå¾ˆå®¹æ˜“è¶…æ—¶è¯¯åˆ¤å¤±è´¥ã€‚

**ä¿®å¤æ–¹æ¡ˆ**: æ ¹æ®æ¢æµ‹çº§åˆ«ä¼ é€’åˆé€‚çš„è¶…æ—¶æ—¶é—´

```python
def probe_thread():
    # P0ä¿®å¤ï¼šæ ¹æ®æ¢æµ‹çº§åˆ«ä¼ é€’åˆé€‚çš„è¶…æ—¶æ—¶é—´
    if level == ProbeLevel.TWOPASS_FULL:
        timeout = 15.0  # å®Œæ•´æ¢æµ‹ç»™ 15 ç§’
    else:
        timeout = 5.0   # è½»é‡æ¢æµ‹ 5 ç§’
    
    result = asyncio.run(probe.probe(level, timeout=timeout))
```

**è¶…æ—¶é…ç½®**:

| æ¢æµ‹çº§åˆ« | GUI ä¼ é€’è¶…æ—¶ | server_probe å†…éƒ¨æœ€å°ä¿è¯ | è¯´æ˜ |
|----------|-------------|-------------------------|------|
| `offline_light` | 5s | 5s | è¿æ¥+ç¦»çº¿æ¢æµ‹ |
| `twopass_full` | 15s | 12s | è¿æ¥+ç¦»çº¿+2pass |

**ä¿®æ”¹æ–‡ä»¶**: `src/python-gui-client/funasr_gui_client_v3.py`

---

### 2.3 P1: ç¼“å­˜æ¢å¤ç»“æœè¢«"æ­£åœ¨æ¢æµ‹"è¿…é€Ÿè¦†ç›–

**é—®é¢˜æ ¹å› **:
`_restore_cached_probe_result()` æ¢å¤ç¼“å­˜åï¼Œç«‹å³è§¦å‘ `_schedule_probe()`ï¼Œç¼“å­˜ç»“æœä¼šè¢«"ğŸ”„ æ­£åœ¨æ¢æµ‹..."è¿…é€Ÿè¦†ç›–ï¼Œç”¨æˆ·å‡ ä¹çœ‹ä¸åˆ°ç¼“å­˜ä»·å€¼ã€‚

**ä¿®å¤æ–¹æ¡ˆ**: æ¢æµ‹æœŸé—´ä¿ç•™ç¼“å­˜æ–‡æœ¬å¹¶è¿½åŠ "åˆ·æ–°ä¸­â€¦"

```python
def _schedule_probe(self):
    """P1ä¿®å¤ï¼šå½“æœ‰ç¼“å­˜æ—¶ï¼Œä¿ç•™ç¼“å­˜ä¿¡æ¯å¹¶è¿½åŠ "åˆ·æ–°ä¸­â€¦""""
    current_text = self.probe_result_var.get()
    cached_prefix = self.lang_manager.get("probe_cached_prefix")
    
    if current_text.startswith(cached_prefix) and hasattr(self, "_last_capabilities"):
        # æœ‰ç¼“å­˜ç»“æœï¼Œä¿ç•™ç¼“å­˜ä¿¡æ¯å¹¶è¿½åŠ "åˆ·æ–°ä¸­"
        # æ ¼å¼ï¼š[ç¼“å­˜] xxx | ğŸ”„ åˆ·æ–°ä¸­...
        refreshing_text = self.lang_manager.get("probe_status_refreshing")
        cached_info = current_text[len(cached_prefix):].strip()
        if cached_info:
            self.probe_result_var.set(f"{cached_prefix} {cached_info} | {refreshing_text}")
        else:
            self.probe_result_var.set(self.lang_manager.get("probe_status_probing"))
    else:
        # æ²¡æœ‰ç¼“å­˜ï¼Œç›´æ¥æ˜¾ç¤º"æ­£åœ¨æ¢æµ‹"
        self.probe_result_var.set(self.lang_manager.get("probe_status_probing"))
```

**æ–°å¢ç¿»è¯‘é”®**:
```python
"probe_status_refreshing": {"zh": "ğŸ”„ åˆ·æ–°ä¸­...", "en": "ğŸ”„ Refreshing..."}
```

**ä¿®æ”¹æ–‡ä»¶**: `src/python-gui-client/funasr_gui_client_v3.py`

---

### 2.4 P2: æµ‹è¯•è„šæœ¬æœªä½¿ç”¨çš„ import

**é—®é¢˜æ ¹å› **:
`test_phase4_5_config_and_2pass_20260127.py` ä¸­ `tempfile` å’Œ `patch` æœªä½¿ç”¨ï¼Œè‹¥å¯ç”¨ flake8 ä¸¥æ ¼è§„åˆ™ä¼šæŠ¥é”™ã€‚

**ä¿®å¤æ–¹æ¡ˆ**: åˆ é™¤æœªä½¿ç”¨çš„ import

```python
# ä¿®æ”¹å‰
import tempfile
from unittest.mock import MagicMock, patch

# ä¿®æ”¹å
from unittest.mock import MagicMock
```

**ä¿®æ”¹æ–‡ä»¶**: `tests/scripts/test_phase4_5_config_and_2pass_20260127.py`

---

### 2.5 P3: æ¢æµ‹ç»“æœæ¡† columnspan æœªè¦†ç›–æ–°å¢æ¢æµ‹çº§åˆ«åˆ—

**é—®é¢˜æ ¹å› **:
æ–°å¢"æ¢æµ‹çº§åˆ«"ä¸‹æ‹‰æ¡†å ç”¨ grid çš„ç¬¬ 4 åˆ—ï¼ˆ`column=4`ï¼‰åï¼Œæ¢æµ‹ç»“æœæ¡†ä»ä½¿ç”¨ `columnspan=4`ï¼ˆè¦†ç›–åˆ— 0-3ï¼‰ï¼Œå¯¼è‡´ç»“æœå±•ç¤ºåŒºåŸŸä¸åŒ…å«æ–°å¢çš„æ¢æµ‹çº§åˆ«åˆ—ï¼Œå‡ºç°å¯¹é½/ç•™ç™½é—®é¢˜ã€‚

**ä¿®å¤æ–¹æ¡ˆ**: å°† `columnspan` ä» 4 æ”¹ä¸º 5

```python
# ä¿®æ”¹å‰
probe_result_frame.grid(
    row=2, column=0, columnspan=4, padx=5, pady=5, sticky=tk.EW
)

# ä¿®æ”¹å
probe_result_frame.grid(
    row=2, column=0, columnspan=5, padx=5, pady=5, sticky=tk.EW
)
```

**ä¿®æ”¹æ–‡ä»¶**: `src/python-gui-client/funasr_gui_client_v3.py`

---

## 3. ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ |
|----------|----------|
| `src/python-gui-client/funasr_gui_client_v3.py` | P0 ç¼“å­˜å†™å›ã€P0 è¶…æ—¶ã€P1 UX ä¼˜åŒ–ã€P3 å¸ƒå±€ä¿®å¤ã€æ–°å¢ç¿»è¯‘é”® |
| `tests/scripts/test_phase4_5_config_and_2pass_20260127.py` | P2 æ¸…ç†æœªä½¿ç”¨ import |

---

## 4. æµ‹è¯•éªŒè¯

### 4.1 è‡ªåŠ¨åŒ–æµ‹è¯•

```
======================================================================
æµ‹è¯•æ€»ç»“
======================================================================
è¿è¡Œæµ‹è¯•æ•°: 14
æˆåŠŸ: 14
å¤±è´¥: 0
é”™è¯¯: 0
======================================================================
```

### 4.2 Lint æ£€æŸ¥

```
No linter errors found.
```

---

## 5. å…³è”çš„ç¬¬ä¸€è½®ä¿®å¤

æœ¬è½®ä¿®å¤æ˜¯å¯¹ç¬¬ä¸€è½®ä¿®å¤çš„è¡¥å……ã€‚ç¬¬ä¸€è½®å·²ä¿®å¤çš„é—®é¢˜ï¼š

| ä¼˜å…ˆçº§ | é—®é¢˜æè¿° | çŠ¶æ€ |
|--------|----------|------|
| P0 | twopass_full è¶…æ—¶æ—¶é—´ä¸è¶³ï¼ˆ5s â†’ 12sï¼‰ | âœ… å·²ä¿®å¤ |
| P0 | twopass_full åœ¨ç¦»çº¿æ— å“åº”æ—¶è·³è¿‡ 2pass | âœ… å·²ä¿®å¤ |
| P1 | ç¼“å­˜å‰ç¼€ `[ç¼“å­˜]` å›½é™…åŒ– | âœ… å·²ä¿®å¤ |
| P1 | ç¼“å­˜æ¢å¤æ—¶æ›´æ–° `probe_reachable` å’ŒæŒ‡ç¤ºå™¨ | âœ… å·²ä¿®å¤ |
| P1 | V2â†’V3 è¿ç§»ä¿ç•™æœªçŸ¥å­—æ®µå¹¶å¤‡ä»½åŸé…ç½® | âœ… å·²ä¿®å¤ |
| P2 | æ¢æµ‹çº§åˆ«å˜æ›´åç«‹å³ä¿å­˜é…ç½® | âœ… å·²ä¿®å¤ |
| P2 | "2passæœªåˆ¤å®š" ä»…åœ¨ç”¨æˆ·é€‰æ‹© 2pass æ¨¡å¼æ—¶æ˜¾ç¤º | âœ… å·²ä¿®å¤ |
| P3 | æµ‹è¯•è„šæœ¬ CRLF æ¢è¡Œç¬¦ | âœ… å·²ä¿®å¤ |

---

## 6. ç´¯è®¡ä¿®å¤ç»Ÿè®¡

| è½®æ¬¡ | P0 | P1 | P2 | P3 | åˆè®¡ |
|------|----|----|----|----|------|
| ç¬¬ä¸€è½® | 2 | 3 | 2 | 1 | 8 |
| ç¬¬äºŒè½® | 2 | 1 | 1 | 1 | 5 |
| **æ€»è®¡** | **4** | **4** | **3** | **2** | **13** |

---

## 7. å·²çŸ¥å¾…è¯„ä¼°é¡¹ï¼ˆæš‚ä¸ä¿®å¤ï¼‰

ä»¥ä¸‹é—®é¢˜åœ¨ä»£ç å®¡æŸ¥ä¸­æå‡ºï¼Œå»ºè®®åç»­è¯„ä¼°ï¼š

1. **æµ‹è¯•è¦†ç›–å¢å¼º**: å½“å‰æµ‹è¯•å"é€»è¾‘è‡ªæµ‹"ï¼Œå»ºè®®è¡¥å……ï¼š
   - æ–‡ä»¶çº§æµ‹è¯•ï¼šç”¨ä¸´æ—¶ç›®å½•ç”ŸæˆçœŸå® `config.json` â†’ è°ƒ `load_config()` â†’ æ–­è¨€æ–‡ä»¶ç¡®å®å‡çº§ä¸º V3
   - æ¢æµ‹çº§æµ‹è¯•ï¼šå¯¹ `ServerProbe.probe()` åšå¯æ§å‡ ws serverï¼Œè¦†ç›–ç¦»çº¿æ— å“åº”ä½†2passæœ‰å“åº”ã€è¶…æ—¶è¾¹ç•Œç­‰åœºæ™¯

2. **æ–‡æ¡£åŒæ­¥**: å»ºè®®åœ¨æŠ€æœ¯å®æ–½æ–¹æ¡ˆä¸­è¡¥å……ï¼š
   - ç¼“å­˜æœ‰æ•ˆæœŸï¼ˆ24hï¼‰
   - `probe_level` UI å–å€¼ï¼ˆ`offline_light` / `twopass_full`ï¼‰
   - "å®Œæ•´æ¢æµ‹å¯èƒ½æ›´æ…¢"çš„ UX æç¤º

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-27 10:35  
**æœ€åæ›´æ–°**: 2026-01-27 10:50 (æ–°å¢ P3 å¸ƒå±€ä¿®å¤)
