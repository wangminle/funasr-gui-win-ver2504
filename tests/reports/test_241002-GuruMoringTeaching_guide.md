# 241002-GuruMoringTeaching.mp3 测试指南

## 测试目的
验证所有针对长音频识别问题的修复是否生效

## 测试文件
- **文件**: `241002-GuruMoringTeaching.mp3`
- **时长**: 195分26秒 (11726.3秒)
- **大小**: 179MB
- **特点**: 长音频，MP3拼接文件

---

## 测试前准备

### 1. 清理旧结果
```bash
# 删除旧的结果文件
rm dev/output/241002-GuruMoringTeaching.* 2>/dev/null
rm dev/output/text.0* 2>/dev/null

# 备份旧日志（可选）
cp dev/logs/funasr_gui_client_$(date +%Y%m%d).log dev/logs/backup_$(date +%Y%m%d_%H%M%S).log
```

### 2. 确认服务器运行
- 服务器地址: `100.116.250.20:10095`
- SSL: 启用
- 确认服务器正常运行

---

## 测试步骤

### 步骤1: 启动GUI客户端
```bash
cd src/python-gui-client
python funasr_gui_client_v2.py
```

### 步骤2: 连接服务器
1. 确认服务器配置：
   - IP: `100.116.250.20`
   - 端口: `10095`
   - SSL: ✓ 启用
2. 点击"连接服务器"
3. 等待连接成功提示

### 步骤3: 选择文件
1. 点击"选择音/视频文件"
2. 选择 `241002-GuruMoringTeaching.mp3`
3. 观察状态栏显示的文件信息

### 步骤4: 开始识别
1. 点击"开始识别"
2. **重要**: 记录开始时间

### 步骤5: 观察识别过程
在识别过程中观察以下内容：

#### 5.1 日志窗口
应该看到类似的日志：
```
文件选择: 241002-GuruMoringTeaching.mp3, 时长: 11726.3秒 (195分26秒)
转写时长计算: 等待超时: 5863秒 (98分钟), 预估时长: 787秒
...
上传进度: 100%
转写阶段开始
...
```

#### 5.2 状态栏
- 上传阶段: "上传中..."
- 转写阶段: "处理中... XX% 剩余XX分XX秒"
- 完成后: "识别完成"

#### 5.3 进度估算
- 注意观察预估时长是否合理
- **新公式**: 超时时间 ≈ 98分钟（文件时长/2）

---

## 预期结果

### ✅ 成功标准

#### 1. 时长计算正确
```
转写时长计算:
  - 等待超时: 约5863秒 (98分钟)
  - 预估时长: 约787秒 (13分钟)
```

#### 2. 接收到stamp_sents结果
日志中应该出现：
```
从 stamp_sents 提取文本，共 XXX 个片段，总长度 XXXXX 字符
```

#### 3. 等待is_final标志
日志中应该出现：
```
收到最终结果标志 (is_final=True)，文本长度: XXXXX
```

#### 4. 生成有效结果文件
```bash
ls -lh dev/output/241002-GuruMoringTeaching.0_0.json
# 应该显示几十KB到几MB，不是2字节
```

#### 5. 显示统计信息
日志中应该出现：
```
============================================================
识别结果统计:
  总接收消息数: X
  总接收字节数: XXX,XXX,XXX bytes (XXX.XX MB)
  总文本长度: XXXXX 字符
  接收总耗时: XXX.XX 秒
  首个结果耗时: X.XX 秒
============================================================
```

#### 6. 成功判定准确
- 退出码 = 0
- 有有效结果文件（>100字节）
- 显示"任务成功"

#### 7. 超时判断准确
- 如果超时，应该在精确的设定时间（98分钟）触发
- 日志应该显示："转写超时: 已用时XXXX秒，超过设定5863秒"

---

## 失败场景测试（可选）

### 测试1: 模拟超时
修改超时时间为很短的值（如60秒）：
```python
# 在 funasr_gui_client_v2.py 中临时修改
self.transcribe_wait_timeout = 60  # 测试用
```
预期：在60秒后准确触发超时

### 测试2: 服务器断开
在识别过程中断开服务器连接：
预期：
- 显示"通信超时"或"连接已关闭"
- 已接收的数据已写入文件（增量写入）

---

## 检查点清单

### 修复验证
- [ ] 1. stamp_sents格式解析成功
  - 日志出现"从 stamp_sents 提取文本"
  
- [ ] 2. is_final判断正确
  - 日志出现"收到最终结果标志 (is_final=True)"
  
- [ ] 3. 增量写入生效
  - 结果文件在识别过程中即可看到（非0字节）
  
- [ ] 4. 结果统计完整
  - 日志包含详细的统计信息
  
- [ ] 5. 超时判断准确
  - 如果发生超时，时间与设定一致
  
- [ ] 6. 超时时长合理
  - 长音频超时时间 ≈ 文件时长/2（最少30分钟）
  
- [ ] 7. 成功判定严格
  - 退出码≠0 或 无有效结果 → 显示失败
  - 退出码=0 且 有有效结果 → 显示成功

---

## 测试数据收集

### 记录以下信息
```
测试时间: ___________
文件名: 241002-GuruMoringTeaching.mp3
文件大小: 179MB
文件时长: 195分26秒

预估超时时间: _______ 秒 (___分钟)
预估转写时长: _______ 秒 (___分钟)

实际开始时间: _______
实际完成时间: _______
实际用时: _______ 秒 (___分钟)

首包结果时间: _______ 秒
总接收字节数: _______ bytes (___MB)
总文本长度: _______ 字符

结果文件大小: _______ bytes (___KB/MB)
退出码: _______
是否成功: □ 是  □ 否
```

### 保存日志
```bash
# 复制本次测试的日志
cp dev/logs/funasr_gui_client_$(date +%Y%m%d).log \
   tests/reports/test_241002_$(date +%Y%m%d_%H%M%S).log

# 复制结果文件
cp dev/output/241002-GuruMoringTeaching.0_0.json \
   tests/reports/result_241002_$(date +%Y%m%d_%H%M%S).json
```

---

## 问题排查

### 如果识别失败

#### 1. 检查连接
```bash
# 测试服务器连接
telnet 100.116.250.20 10095
```

#### 2. 检查日志
```bash
# 查看客户端日志
tail -f dev/logs/funasr_gui_client_$(date +%Y%m%d).log

# 查看服务器日志（如果有权限）
tail -f dev/server-logs/log-server-$(date +%Y%m%d).txt
```

#### 3. 检查结果文件
```bash
# 查看结果文件大小
ls -lh dev/output/241002-GuruMoringTeaching.*

# 查看结果文件内容（前100行）
head -n 100 dev/output/text.0_0
```

#### 4. 常见问题
- **问题**: 显示"识别失败: 未收到有效识别结果"
  - **原因**: 结果文件<100字节
  - **检查**: 查看日志中是否有"从 stamp_sents 提取文本"
  
- **问题**: 显示"识别失败: 进程异常退出(退出码:1)"
  - **原因**: 子进程异常终止
  - **检查**: 查看日志中的错误信息

- **问题**: 超时但时间不准确
  - **原因**: 可能代码未生效
  - **检查**: 确认修改的代码已保存并重新加载

---

## 成功案例参考

### 预期的成功日志片段
```
2025-10-31 XX:XX:XX - INFO - 文件选择: 241002-GuruMoringTeaching.mp3, 时长: 11726.3秒 (195分26秒)
2025-10-31 XX:XX:XX - INFO - 转写时长计算 - 文件时长: 195分26秒, 等待超时: 5863秒, 预估时长: 787秒
2025-10-31 XX:XX:XX - INFO - 用户操作: 开始识别音频/视频文件
2025-10-31 XX:XX:XX - INFO - 转写阶段开始，启动进度倒计时
2025-10-31 XX:XX:XX - INFO - 从 stamp_sents 提取文本，共 XXX 个片段，总长度 XXXXX 字符
2025-10-31 XX:XX:XX - INFO - 收到首个识别结果，消息序号: 1
2025-10-31 XX:XX:XX - INFO - 收到最终结果标志 (is_final=True)，文本长度: XXXXX
2025-10-31 XX:XX:XX - INFO - 识别结果统计: ...
2025-10-31 XX:XX:XX - INFO - 检测到有效结果文件: 241002-GuruMoringTeaching.0_0.json (XXXXX 字节)
2025-10-31 XX:XX:XX - INFO - 任务成功: 文件 241002-GuruMoringTeaching.mp3 识别完成。
```

---

## 报告模板

测试完成后，请填写以下报告并保存到 `tests/reports/test_241002_YYYYMMDD.md`：

```markdown
# 241002-GuruMoringTeaching.mp3 测试报告

## 测试信息
- **测试时间**: YYYY-MM-DD HH:MM:SS
- **测试人员**: [姓名]
- **代码版本**: [Git commit hash]

## 测试结果
- **是否成功**: □ 是  □ 否
- **实际用时**: XXX秒 (XX分XX秒)
- **结果文件大小**: XXX KB/MB

## 修复验证
- [ ] stamp_sents格式解析成功
- [ ] is_final判断正确
- [ ] 增量写入生效
- [ ] 结果统计完整
- [ ] 超时判断准确
- [ ] 超时时长合理
- [ ] 成功判定严格

## 发现的问题
[如有问题，请详细描述]

## 日志附件
- 客户端日志: tests/reports/test_241002_YYYYMMDD_HHMMSS.log
- 结果文件: tests/reports/result_241002_YYYYMMDD_HHMMSS.json

## 结论
[总结测试结果和建议]
```

---

## 联系支持
如有任何问题，请查看：
1. `dev/output/241002-GuruMoringTeaching_issue_analysis.md` - 问题分析
2. `dev/output/timeout_mechanism_analysis.md` - 超时机制分析
3. `dev/output/fix_summary_20251031.md` - 修复总结

